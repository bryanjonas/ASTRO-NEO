{% set selected_name = selected_preset.name if selected_preset else None %}
<div class="panel-title small">Exposure Presets (NEOCP Astrometry)</div>
<div class="info-banner">
  üì∏ Configured for NEOCP astrometry: 3‚Äì6 exposures per target, 60‚Äì120s each, with 1‚Äì3 min spacing for motion detection
</div>
{% if error %}<div class="error">{{ error }}</div>{% endif %}

{% if selected_preset %}
  <form class="selected-preset-card" hx-post="/dashboard/exposure/config" hx-target="closest .subpanel" hx-swap="innerHTML">
    <div class="selected-preset-header">
      <div>
        <div class="selected-preset-label">Imaging configuration</div>
        <div class="selected-preset-name">{{ selected_preset.name|capitalize }}</div>
      </div>
      <div class="selected-preset-summary">
        <span>{{ selected_preset.count }} √ó {{ selected_preset.exposure_seconds }}s</span>
        <span>Spacing {{ selected_preset.delay_seconds }}s</span>
        <span>{{ selected_preset.filter }} @ bin {{ selected_preset.binning }}</span>
      </div>
    </div>
    <div class="selected-config-grid">
      <label>
        <span class="selected-label">Exposure (s)</span>
        <input type="number" step="1" min="1" name="exposure_seconds" value="{{ selected_preset.exposure_seconds }}">
      </label>
      <label>
        <span class="selected-label">Count</span>
        <input type="number" min="1" name="count" value="{{ selected_preset.count }}">
      </label>
      <label>
        <span class="selected-label">Spacing (s)</span>
        <input type="number" min="0" name="delay_seconds" value="{{ selected_preset.delay_seconds }}">
      </label>
      <label>
        <span class="selected-label">Filter</span>
        <input type="text" name="filter" value="{{ selected_preset.filter }}">
      </label>
      <label>
        <span class="selected-label">Binning</span>
        <input type="number" min="1" name="binning" value="{{ selected_preset.binning }}">
      </label>
      <div>
        <span class="selected-label">Est. duration</span>
        <span class="selected-value">{{ selected_preset.total_minutes }} min</span>
      </div>
    </div>
    <div class="actions">
      <button type="submit" class="btn-primary">üíæ Save imaging configuration</button>
    </div>
  </form>
{% else %}
  <div class="muted tiny">No preset selected yet. Choose one below to arm the next imaging sequence.</div>
{% endif %}

{% if presets %}
  <div class="preset-grid">
    {% for preset in presets %}
      {% set is_selected = selected_name and selected_name|lower == preset.name|lower %}
      <div class="preset-card {% if is_selected %}is-active{% endif %}">
        <div class="preset-header">
          <strong>{{ preset.name|capitalize }}</strong>
          <span class="preset-vmag">V‚â§{{ preset.max_vmag }}</span>
        </div>
        <div class="preset-details">
          <div class="preset-row">
            <span class="preset-label">Exposure:</span>
            <span class="preset-value">{{ preset.exposure_seconds }}s</span>
          </div>
          <div class="preset-row">
            <span class="preset-label">Count:</span>
            <span class="preset-value">{{ preset.count }} images</span>
          </div>
          <div class="preset-row">
            <span class="preset-label">Spacing:</span>
            <span class="preset-value">{{ preset.delay_seconds }}s ({{ (preset.delay_seconds / 60.0)|round(1) }} min)</span>
          </div>
          <div class="preset-row">
            <span class="preset-label">Filter:</span>
            <span class="preset-value">{{ preset.filter }}</span>
          </div>
          <div class="preset-row">
            <span class="preset-label">Binning:</span>
            <span class="preset-value">{{ preset.binning }}√ó{{ preset.binning }}</span>
          </div>
          <div class="preset-row">
            <span class="preset-label">Total time:</span>
            <span class="preset-value">{{ ((preset.count * preset.exposure_seconds + (preset.count - 1) * preset.delay_seconds) / 60.0)|round(1) }} min</span>
          </div>
        </div>
        <div class="preset-actions">
          <form hx-post="/dashboard/exposure/select" hx-target="closest .subpanel" hx-swap="innerHTML">
            <input type="hidden" name="preset_name" value="{{ preset.name }}">
            <button type="submit" class="btn-secondary {% if is_selected %}selected{% endif %}" {% if is_selected %}disabled{% endif %}>
              {% if is_selected %}Selected{% else %}Use this preset{% endif %}
            </button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="calibration-note">
    <strong>üìù Calibration Note:</strong> Calibration frames (bias/darks/flats) should be taken at the start of your session in NINA and reused for all targets. Master frames are applied during reduction, not re-shot for each NEO.
  </div>
{% else %}
  <div class="muted">No exposure presets configured</div>
{% endif %}
