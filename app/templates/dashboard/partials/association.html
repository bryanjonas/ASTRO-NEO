<div id="association-view" hx-get="/dashboard/partials/association?target={{ selected_target }}" hx-trigger="every 20s"
  hx-target="this" hx-swap="outerHTML">
  <div class="panel-title">Association</div>
  <p class="panel-description">Align detections to the predicted NEOCP position; add manual centroids when automation is
    unsure.</p>

  {% if error %}
  <div class="panel warn" style="margin-bottom: 1rem;">
    {{ error }}
  </div>
  {% endif %}

  {% if targets %}
  <form class="targets-controls" hx-get="/dashboard/partials/association" hx-target="#association-view"
    hx-swap="outerHTML">
    <label class="muted tiny">Select target</label>
    <select name="target" onchange="this.form.submit()">
      {% for t in targets %}
      <option value="{{ t.name }}" {% if t.name==selected_target %}selected{% endif %}>
        {{ t.name }} ({{ t.count }})
      </option>
      {% endfor %}
    </select>
  </form>
  {% endif %}

  {% if captures %}
  <table class="solver-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Started</th>
        <th>Predicted RA/Dec</th>
        <th>Associated RA/Dec</th>
        <th>Status</th>
        <th>Review</th>
      </tr>
    </thead>
    <tbody>
      {% for cap in captures %}
      {% set assoc = associations.get(cap.path) if associations else None %}
      {% set pred = predicted.get(cap.path) if predicted else None %}
      <tr>
        <td>{{ cap.index or '-' }}</td>
        <td>{{ cap.started_at }}</td>
        <td class="muted tiny">
          {% if pred %}
          {{ '%.5f'|format(pred.ra_deg) }}, {{ '%.5f'|format(pred.dec_deg) }}
          {% else %}
          Ephemeris pending
          {% endif %}
        </td>
        <td>
          {% if assoc %}
          {{ '%.5f'|format(assoc.ra_deg) }}, {{ '%.5f'|format(assoc.dec_deg) }}
          {% else %}
          â€”
          {% endif %}
        </td>
        <td>
          {% if assoc %}
          <span class="pill good">associated</span>
          {% else %}
          <span class="pill warn">pending</span>
          {% endif %}
        </td>
        <td>
          <button class="btn-secondary small" hx-get="/dashboard/partials/review_modal?path={{ cap.path }}"
            hx-target="#association-view" hx-swap="outerHTML" hx-indicator="#association-loading">
            Review
          </button>
          <div id="association-loading" class="htmx-indicator center-overlay">
            <div class="loader"></div> Loading Review...
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="muted">No captures recorded for association yet.</div>
  {% endif %}
</div>