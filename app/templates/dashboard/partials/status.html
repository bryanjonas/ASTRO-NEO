{% set nina = bundle.bridge_status or {} %}
{% set telescope = nina.get("telescope", {}) %}
{% set camera = nina.get("camera", {}) %}
{% set sequence = nina.get("sequence", {}) %}
{% set focuser = nina.get("focuser", {}) %}
{% set session = bundle.session %}
{% set session_active = session is not none %}
{% set session_paused = session and session.get("paused") %}
{% set seq_total = sequence.get("total") if sequence and sequence.get("total") is not none else 0 %}
{% set seq_index = sequence.get("current_index") if sequence and sequence.get("current_index") is not none else 0 %}
{% set exposures_left = seq_total - seq_index %}
{% if exposures_left < 0 %}{% set exposures_left=0 %}{% endif %} <section class="panel">
  <div class="status-grid">
    <!-- Left Column: Controls & Telemetry -->
    <div class="status-main">
      <div class="panel-header-row">
        <div class="panel-title">System Status</div>
        <div class="actions">
          {% if not session_active %}
          <button class="btn-primary" hx-post="/dashboard/night/start" hx-target="closest section" hx-swap="outerHTML">
            ‚ú® Start Auto-Pilot
          </button>
          {% else %}
          <button class="btn-secondary" hx-post="/dashboard/night/pause" hx-target="closest section"
            hx-swap="outerHTML">
            {% if session_paused %}‚ñ∂Ô∏è Resume{% else %}‚è∏Ô∏è Pause{% endif %}
          </button>
          <button class="btn-danger ghost" hx-post="/dashboard/night/end" hx-target="closest section"
            hx-swap="outerHTML">
            üõë End
          </button>
          {% endif %}
        </div>
      </div>

      {% if status_banner %}
      <div class="status-banner {{ status_banner.kind }}">{{ status_banner.text }}</div>
      {% endif %}

      <!-- Unified Health Strip -->
      <div class="health-strip">
        <div class="health-item">
          <span class="health-label">Bridge</span>
          <span class="health-value">
            {% if bundle.bridge_ready %}
            <span class="dot good"></span> Ready
            {% else %}
            <span class="dot warn"></span> Not Ready
            {% endif %}
          </span>
        </div>
        <div class="health-item">
          <span class="health-label">Telescope</span>
          <span class="health-value">
            {% if telescope and telescope.get("is_connected") %}
            <span class="dot good"></span> Connected
            {% else %}
            <span class="dot error"></span> Disconnected
            {% endif %}
          </span>
        </div>
        <div class="health-item">
          <span class="health-label">Camera</span>
          <span class="health-value">
            {% if camera and camera.get("is_exposing") %}
            <span class="dot good"></span> Exposing
            {% else %}
            <span class="dot neutral"></span> Idle
            {% endif %}
          </span>
        </div>
        <div class="health-item">
          <span class="health-label">Sequence</span>
          <span class="health-value">
            {% if sequence and sequence.get("is_running") %}
            <span class="dot good"></span> Running
            {% else %}
            <span class="dot neutral"></span> Stopped
            {% endif %}
          </span>
        </div>
      </div>

      {% set blockers = bundle.bridge_blockers_filtered if bundle.bridge_blockers_filtered is defined else
      bundle.bridge_blockers %}
      {% if blockers %}
      <div class="alert-box warn">
        <strong>Blockers:</strong>
        <ul class="inline-list">
          {% for b in blockers %}<li>{{ b.reason if b.reason else b }}</li>{% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Compact Telemetry -->
      <div class="telemetry-grid compact">
        <div class="telemetry-card">
          <div class="telemetry-label">Target</div>
          <div class="telemetry-value large">
            {{ sequence.get("name") if sequence and sequence.get("name") else "‚Äî" }}
          </div>
          <div class="telemetry-meta">
            {% if sequence and sequence.get("total") %}
            Frame {{ seq_index }} / {{ sequence.get("total") }}
            {% else %}
            No active plan
            {% endif %}
          </div>
        </div>

        <div class="telemetry-card">
          <div class="telemetry-label">Mount Position</div>
          <div class="telemetry-value">
            RA {{ "%.4f"|format(telescope.get("ra_deg")) if telescope and telescope.get("ra_deg") is not none else "‚Äî"
            }}
          </div>
          <div class="telemetry-value">
            DEC {{ "%.4f"|format(telescope.get("dec_deg")) if telescope and telescope.get("dec_deg") is not none else
            "‚Äî" }}
          </div>
          <div class="telemetry-meta">
            {{ telescope.get("tracking_mode") if telescope and telescope.get("tracking_mode") else "Stopped" }}
          </div>
        </div>

        <div class="telemetry-card">
          <div class="telemetry-label">Last Image</div>
          <div class="telemetry-value">
            {{ camera.get("last_exposure_duration") if camera and camera.get("last_exposure_duration") else "0" }}s
          </div>
          <div class="telemetry-meta truncate">
            {{ camera.get("last_image_path") | basename if camera and camera.get("last_image_path") else "‚Äî" }}
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: System Activity -->
    <div class="status-aside">
      <div class="panel-title small">System Activity</div>
      <div class="system-log full-height">
        {% if bundle.notifications %}
        {% for note in bundle.notifications %}
        <div class="system-log-item">
          <span class="system-log-time">{{ note.created_at }}</span>
          <span class="system-log-msg {{ note.level }}">{{ note.message }}</span>
        </div>
        {% endfor %}
        {% else %}
        <div class="muted tiny" style="padding: 10px;">No recent activity recorded.</div>
        {% endif %}
      </div>
    </div>
  </div>
  </section>