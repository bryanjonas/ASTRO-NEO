{% set nina = bundle.bridge_status or {} %}
{% set telescope = nina.get("telescope", {}) %}
{% set camera = nina.get("camera", {}) %}
{% set sequence = nina.get("sequence", {}) %}
{% set focuser = nina.get("focuser", {}) %}
{% set session = bundle.session %}
{% set session_active = session is not none %}
{% set session_paused = session and session.get("paused") %}
{% set seq_total = sequence.get("total") if sequence and sequence.get("total") is not none else 0 %}
{% set seq_index = sequence.get("current_index") if sequence and sequence.get("current_index") is not none else 0 %}
{% set exposures_left = seq_total - seq_index %}
{% if exposures_left < 0 %}{% set exposures_left=0 %}{% endif %} <div id="overview-content" {% if oob
  %}hx-swap-oob="true" {% endif %}>
  <div class="status-grid">
    <!-- Left Column: Controls & Telemetry -->
    <div class="status-main">
      <div class="panel-header-row">
        <div class="panel-title">System Status</div>
        <div class="actions">
          {% if not session_active %}
          {% set weather_safe = bundle.ignore_weather or (bundle.weather_summary and bundle.weather_summary.is_safe) or
          False %}
          {% set system_ready = (not bundle.bridge_blockers) and telescope.get("is_connected") and
          camera.get("is_connected") and weather_safe %}
          <!-- DEBUG: Ready={{ system_ready }} Blockers={{ bundle.bridge_blockers }} Scope={{ telescope.get("is_connected") }} Cam={{ camera.get("is_connected") }} WX={{ weather_safe }} -->
          <button class="btn-primary" hx-post="/dashboard/night/start" hx-target="closest section" hx-swap="innerHTML"
            {% if not system_ready %}disabled style="opacity: 0.5; cursor: not-allowed;"
            title="Ensure Bridge, Mount, Camera, and Weather are green" {% endif %}>
            ‚ú® Start Auto-Pilot
          </button>
          {% else %}
          <button class="btn-secondary" hx-post="/dashboard/night/pause" hx-target="closest section"
            hx-swap="innerHTML">
            {% if session_paused %}‚ñ∂Ô∏è Resume{% else %}‚è∏Ô∏è Pause{% endif %}
          </button>
          <button class="btn-danger ghost" hx-post="/dashboard/night/end" hx-target="closest section"
            hx-swap="innerHTML">
            üõë End
          </button>
          {% endif %}
        </div>
      </div>

      {% if status_banner %}
      <div class="status-banner {{ status_banner.kind }}">{{ status_banner.text }}</div>
      {% endif %}

      <!-- Unified Health Strip -->
      <div class="health-strip">
        <div class="health-item">
          <span class="health-label">Bridge</span>
          <span class="health-value">
            {% if bundle.bridge_ready %}
            <span class="dot good"></span> Ready
            {% else %}
            <span class="dot warn"></span> Not Ready
            {% endif %}
          </span>
        </div>
        <div class="health-item" style="cursor: pointer;" @click="$dispatch('open-mount-modal')"
          title="Click to select mount">
          <span class="health-label">Mount Select</span>
          <span class="health-value">
            {% if telescope and telescope.get("is_connected") %}
            <span class="dot good"></span> Connected
            {% else %}
            <span class="dot error"></span>
            <span class="pulse-text">Select ‚ñæ</span>
            {% endif %}
          </span>
        </div>
        <div class="health-item" style="cursor: pointer;" @click="$dispatch('open-camera-modal')"
          title="Click to select camera">
          <span class="health-label">Camera Select</span>
          <span class="health-value">
            {% if camera and camera.get("is_exposing") %}
            <span class="dot warn"></span> Exposing
            {% elif camera and camera.get("is_connected") %}
            <span class="dot good"></span> Connected
            {% else %}
            <span class="dot error"></span>
            <span class="pulse-text">Select ‚ñæ</span>
            {% endif %}
          </span>
        </div>

        <div class="health-item">
          <span class="health-label">Weather</span>
          <div class="health-value-row">
            <span class="health-value">
              {% if bundle.ignore_weather %}
              <span class="dot warn"></span> Ignored
              {% elif bundle.weather_summary and not bundle.weather_summary.is_safe %}
              <span class="dot error"></span> Unsafe
              {% elif bundle.weather_summary and bundle.weather_summary.is_safe %}
              <span class="dot good"></span> Safe
              {% else %}
              <span class="dot warn"></span> No Data
              {% endif %}
            </span>
            <form hx-post="/dashboard/weather/override" hx-target="closest section" hx-swap="innerHTML"
              style="display:inline-flex;">
              <input type="hidden" name="ignore" value="{{ 'false' if bundle.ignore_weather else 'true' }}">
              <button type="submit" class="ghost-tiny {{ 'warn' if bundle.ignore_weather }}"
                title="{{ 'Disable Override' if bundle.ignore_weather else 'Enable Override' }}">
                {{ 'WX Override: ON' if bundle.ignore_weather else 'WX Override' }}
              </button>
            </form>
          </div>
        </div>

        <div class="health-item">
          <span class="health-label">Target</span>
          <span class="health-value">
            {% if bundle.target_available == "Available" %}
            <span class="dot good"></span> Available
            {% elif "Waiting" in (bundle.target_available or "") %}
            <span class="dot warn"></span> {{ bundle.target_available }}
            {% else %}
            <span class="dot error"></span> {{ bundle.target_available or 'None' }}
            {% endif %}
          </span>
        </div>
      </div>

      {% set blockers = bundle.bridge_blockers_filtered if bundle.bridge_blockers_filtered is defined else
      bundle.bridge_blockers %}
      {% if blockers %}
      <div class="alert-box warn">
        <strong>Blockers:</strong>
        <ul class="inline-list">
          {% for b in blockers %}<li>{{ b.reason if b.reason else b }}</li>{% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Compact Telemetry -->
      <div class="telemetry-grid compact">
        <div class="telemetry-card">
          <div class="telemetry-label">Imaging Plan</div>
          <div class="telemetry-value large">
            {{ (session.get("selected_target") if session else None) or sequence.get("name") or (session.get("target")
            if session else None) or "‚Äî" }}
          </div>
          <div class="telemetry-meta">
            {% if sequence and sequence.get("total") %}
            Frame {{ seq_index }} / {{ sequence.get("total") }}
            {% elif session and session.get("selected_preset") %}
            {% set p = session.get("selected_preset") %}
            Plan: {{ p.count }} x {{ p.exposure_seconds }}s
            {% else %}
            No active plan
            {% endif %}
          </div>
          {% if session and session.get("selected_target_ra") %}
          <div class="telemetry-meta">
            Target: {{ "%.4f"|format(session.get("selected_target_ra")) }}, {{ "%.4f"|format(session.get("selected_target_dec")) }}
          </div>
          {% endif %}
          <div class="telemetry-meta">
            {{ camera.get("last_exposure_duration") if camera and camera.get("last_exposure_duration") else "0" }}s Exp
          </div>
        </div>

        <div class="telemetry-card">
          <div class="telemetry-label">Mount Position</div>
          <div class="telemetry-value">
            RA {{ "%.4f"|format(telescope.get("ra_deg")) if telescope and telescope.get("ra_deg") is not none else "‚Äî"
            }}
          </div>
          <div class="telemetry-value">
            DEC {{ "%.4f"|format(telescope.get("dec_deg")) if telescope and telescope.get("dec_deg") is not none else
            "‚Äî" }}
          </div>
          <div class="telemetry-meta">
            {{ telescope.get("tracking_mode") if telescope and telescope.get("tracking_mode") else "Stopped" }}
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: System Activity -->
    <div class="status-aside">
      <div class="panel-title small">System Activity</div>
      <div class="system-log full-height">
        {% if bundle.notifications %}
        {% for note in bundle.notifications %}
        <div class="system-log-item">
          <span class="system-log-time">{{ note.created_at }}</span>
          <span class="system-log-msg {{ note.level }}">{{ note.message }}</span>
        </div>
        {% endfor %}
        {% else %}
        <div class="muted tiny" style="padding: 10px;">No recent activity recorded.</div>
        {% endif %}
      </div>
    </div>
  </div>
  </div>