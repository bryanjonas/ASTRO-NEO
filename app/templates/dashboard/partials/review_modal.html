<div class="modal-backdrop" _="on click remove me"></div>
<div class="modal" style="width: 90vw; height: 90vh; max-width: 1200px; display: flex; flex-direction: column;">
    <div class="modal-header">
        <h3>Review Capture: {{ meta.path|basename }}</h3>
        <button class="btn-icon" _="on click remove closest .modal-backdrop">Ã—</button>
    </div>

    <div class="modal-body" style="flex: 1; display: flex; gap: 1rem; overflow: hidden;">
        <!-- Image Viewer -->
        <div class="viewer-container"
            style="flex: 1; position: relative; background: #000; overflow: auto; cursor: crosshair;">
            {% if preview %}
            <img id="review-image" src="data:image/png;base64,{{ preview }}" style="display: block; max-width: none;">
            <canvas id="drawing-canvas" style="position: absolute; top: 0; left: 0;"></canvas>
            {% else %}
            <div class="muted">No preview available.</div>
            {% endif %}
        </div>

        <!-- Controls -->
        <div class="controls-panel"
            style="width: 300px; display: flex; flex-direction: column; gap: 1rem; border-left: 1px solid #333; padding: 1rem; background: #1a1a1a;">
            <div class="panel">
                <h4>Instructions</h4>
                <p class="tiny muted">1. Click on the image to draw a polygon around the target.</p>
                <p class="tiny muted">2. Click "Identify" to find the centroid.</p>

                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                    <button id="btn-identify" class="btn-primary" disabled>Identify Centroid</button>
                    <button id="btn-reset" class="btn-secondary">Reset Polygon</button>
                </div>
            </div>

            <div id="resolution-result" class="panel hidden" style="border-top: 1px solid #333; padding-top: 1rem;">
                <h4>Source Identified</h4>
                <div class="kv-grid"
                    style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; margin-bottom: 1rem;">
                    <span class="label muted">RA</span>
                    <span class="value mono" id="res-ra">-</span>
                    <span class="label muted">Dec</span>
                    <span class="value mono" id="res-dec">-</span>
                    <span class="label muted">SNR</span>
                    <span class="value mono" id="res-snr">-</span>
                </div>

                <form hx-post="/dashboard/association/manual" hx-target="#association-section" hx-swap="outerHTML">
                    <input type="hidden" name="path" value="{{ meta.path }}">
                    <input type="hidden" name="ra_deg" id="input-ra">
                    <input type="hidden" name="dec_deg" id="input-dec">
                    <button type="submit" class="btn-primary full-width" _="on click remove closest .modal-backdrop">
                        Confirm Association
                    </button>
                </form>
            </div>

            <div id="resolution-loading" class="panel hidden" style="display: none;">
                <div class="loader"></div> Resolving...
            </div>

            <div id="resolution-error" class="panel warn hidden">
                <span id="error-msg"></span>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const img = document.getElementById('review-image');
        const canvas = document.getElementById('drawing-canvas');
        const resultPanel = document.getElementById('resolution-result');
        const loadingPanel = document.getElementById('resolution-loading');
        const errorPanel = document.getElementById('resolution-error');

        const btnIdentify = document.getElementById('btn-identify');
        const btnReset = document.getElementById('btn-reset');

        if (!img) return;

        let points = [];
        let ctx = canvas ? canvas.getContext('2d') : null;

        // Init canvas size
        function resizeCanvas() {
            if (img && canvas) {
                canvas.width = img.clientWidth;
                canvas.height = img.clientHeight;
                draw();
            }
        }

        img.onload = resizeCanvas;

        // Default to polygon mode behavior
        canvas.style.pointerEvents = 'auto';
        img.style.cursor = 'default';

        btnReset.onclick = () => resetPoly();

        function resetPoly() {
            points = [];
            btnIdentify.disabled = true;
            resultPanel.classList.add('hidden');
            errorPanel.classList.add('hidden');
            draw();
        }

        function draw() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (points.length > 0) {
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                if (points.length > 2) {
                    ctx.closePath();
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
                    ctx.fill();
                }
                ctx.strokeStyle = '#0f0';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw points
                ctx.fillStyle = '#fff';
                for (let p of points) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        // Handle clicks on canvas
        canvas.addEventListener('click', function (e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            points.push({ x, y });
            if (points.length >= 3) btnIdentify.disabled = false;
            draw();
        });

        btnIdentify.onclick = async function () {
            if (points.length < 3) return;

            // Convert points to image coordinates
            const rect = img.getBoundingClientRect();
            const scaleX = img.naturalWidth / rect.width;
            const scaleY = img.naturalHeight / rect.height;

            const imgPoints = points.map(p => ({
                x: p.x * scaleX,
                y: p.y * scaleY
            }));

            // Show loading
            loadingPanel.classList.remove('hidden');
            resultPanel.classList.add('hidden');
            errorPanel.classList.add('hidden');

            try {
                const resp = await fetch('/dashboard/analysis/resolve_click', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: "{{ meta.path }}",
                        polygon: imgPoints
                    })
                });

                const data = await resp.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Update Result Panel
                document.getElementById('res-ra').textContent = data.ra_deg.toFixed(5);
                document.getElementById('res-dec').textContent = data.dec_deg.toFixed(5);
                document.getElementById('res-snr').textContent = data.snr.toFixed(1);

                document.getElementById('input-ra').value = data.ra_deg;
                document.getElementById('input-dec').value = data.dec_deg;

                resultPanel.classList.remove('hidden');

            } catch (err) {
                document.getElementById('error-msg').textContent = err.message;
                errorPanel.classList.remove('hidden');
            } finally {
                loadingPanel.classList.add('hidden');
            }
        };
    })();
</script>