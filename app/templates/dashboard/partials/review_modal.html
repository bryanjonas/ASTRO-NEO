<div id="association-view" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
    <div class="modal-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <h3>Review Capture: {{ meta.path|basename }}</h3>
            {% if navigation %}
            <div class="nav-controls" style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                <button class="btn-secondary small" {% if navigation.prev %}
                    hx-get="/dashboard/partials/review_modal?path={{ navigation.prev }}" hx-target="#association-view"
                    hx-swap="outerHTML" id="btn-prev" {% else %}disabled{% endif %}>
                    &larr; Prev
                </button>
                <span class="muted tiny">{{ navigation.current }} / {{ navigation.total }}</span>
                <button class="btn-secondary small" {% if navigation.next %}
                    hx-get="/dashboard/partials/review_modal?path={{ navigation.next }}" hx-target="#association-view"
                    hx-swap="outerHTML" id="btn-next" {% else %}disabled{% endif %}>
                    Next &rarr;
                </button>
            </div>
            {% endif %}
        </div>
        <button class="btn-secondary" hx-get="/dashboard/partials/association?target={{ meta.target }}"
            hx-target="#association-view" hx-swap="outerHTML">Back to List</button>
    </div>

    <div class="modal-body" style="flex: 1; display: flex; gap: 1rem; overflow: hidden; min-height: 600px;">
        <!-- Image Viewer -->
        <div class="viewer-container"
            style="flex: 1; position: relative; background: #000; overflow: auto; cursor: crosshair;">
            {% if preview %}
            <img id="review-image" src="data:image/png;base64,{{ preview }}" style="display: block; max-width: none;">
            <canvas id="drawing-canvas" style="position: absolute; top: 0; left: 0; z-index: 10;"></canvas>
            {% else %}
            <div class="muted">No preview available.</div>
            {% endif %}
        </div>

        <!-- Controls -->
        <div class="controls-panel"
            style="width: 300px; display: flex; flex-direction: column; gap: 1rem; border-left: 1px solid #333; padding: 1rem; background: #1a1a1a;">
            <div class="panel">
                <h4>Instructions</h4>
                <p class="tiny muted">1. Click on the image to draw a polygon around the target.</p>
                <p class="tiny muted">2. Click "Identify" to find the centroid.</p>
                <p class="tiny muted">3. Use Left/Right arrow keys to blink between images.</p>

                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                    <button id="btn-identify" class="btn-primary" disabled>Identify Centroid</button>
                    <button id="btn-reset" class="btn-secondary">Reset Polygon</button>
                </div>
            </div>

            <div id="resolution-result" class="panel {% if not association %}hidden{% endif %}"
                style="border-top: 1px solid #333; padding-top: 1rem;">
                <h4>Source Identified</h4>
                <div class="kv-grid"
                    style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; margin-bottom: 1rem;">
                    <span class="label muted">RA</span>
                    <span class="value mono" id="res-ra">{{ '%.5f'|format(association.ra_deg) if association else '-'
                        }}</span>
                    <span class="label muted">Dec</span>
                    <span class="value mono" id="res-dec">{{ '%.5f'|format(association.dec_deg) if association else '-'
                        }}</span>
                    <span class="label muted">SNR</span>
                    <span class="value mono" id="res-snr">-</span>
                </div>

                <form hx-post="/dashboard/association/manual" hx-target="#association-view" hx-swap="outerHTML">
                    <input type="hidden" name="path" value="{{ meta.path }}">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div>
                            <label class="tiny muted">RA</label>
                            <input type="number" step="0.00001" name="ra_deg" id="input-ra" class="full-width" required
                                value="{{ '%.5f'|format(association.ra_deg) if association else '' }}">
                        </div>
                        <div>
                            <label class="tiny muted">Dec</label>
                            <input type="number" step="0.00001" name="dec_deg" id="input-dec" class="full-width"
                                required value="{{ '%.5f'|format(association.dec_deg) if association else '' }}">
                        </div>
                    </div>

                    <button type="submit" class="btn-primary full-width">
                        Confirm Association
                    </button>
                </form>
            </div>

            <div id="resolution-loading" class="panel hidden" style="display: none;">
                <div class="loader"></div> Resolving...
            </div>

            <div id="resolution-error" class="panel warn hidden">
                <span id="error-msg"></span>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const img = document.getElementById('review-image');
        const canvas = document.getElementById('drawing-canvas');
        const resultPanel = document.getElementById('resolution-result');
        const loadingPanel = document.getElementById('resolution-loading');
        const errorPanel = document.getElementById('resolution-error');

        const btnIdentify = document.getElementById('btn-identify');
        const btnReset = document.getElementById('btn-reset');

        // Keyboard navigation
        document.addEventListener('keydown', function (e) {
            // Only if modal is active (simple check: if btnIdentify exists)
            if (!document.body.contains(btnIdentify)) return;

            if (e.key === 'ArrowLeft') {
                const btn = document.getElementById('btn-prev');
                if (btn && !btn.disabled) btn.click();
            } else if (e.key === 'ArrowRight') {
                const btn = document.getElementById('btn-next');
                if (btn && !btn.disabled) btn.click();
            }
        });

        if (!img) return;

        let points = [];
        let ctx = canvas ? canvas.getContext('2d') : null;
        let isDrawing = false;
        let currentX = 0;
        let currentY = 0;
        let currentMarker = null; // Moved up to avoid TDZ

        // Init canvas size
        function resizeCanvas() {
            if (img && canvas) {
                // Ensure image has dimensions
                if (img.clientWidth === 0 || img.clientHeight === 0) {
                    return; // Wait for layout
                }
                canvas.width = img.clientWidth;
                canvas.height = img.clientHeight;
                draw();
            }
        }

        if (img.complete) {
            resizeCanvas();
        } else {
            img.onload = resizeCanvas;
        }

        // Also resize on window resize in case modal size changes
        window.addEventListener('resize', resizeCanvas);

        // Default to polygon mode behavior
        canvas.style.pointerEvents = 'auto';
        img.style.cursor = 'default';

        btnReset.onclick = () => resetPoly();

        function resetPoly() {
            points = [];
            btnIdentify.disabled = true;
            resultPanel.classList.add('hidden');
            errorPanel.classList.add('hidden');
            draw();
        }

        // Marker state
        // currentMarker is now declared at the top

        function draw() {
            if (!canvas || !img) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw polygon
            if (points.length > 0) {
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                if (isDrawing) {
                    ctx.lineTo(currentX, currentY);
                } else {
                    ctx.closePath();
                }
                ctx.strokeStyle = '#5dd4ff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillStyle = 'rgba(93, 212, 255, 0.2)';
                ctx.fill();
            }

            // Draw marker if exists
            if (currentMarker) {
                const x = currentMarker.x;
                const y = currentMarker.y;

                ctx.beginPath();
                ctx.arc(x, y, 10, 0, 2 * Math.PI);
                ctx.strokeStyle = '#3fb950'; // Green for confirmed/associated
                ctx.lineWidth = 2;
                ctx.stroke();

                // Crosshair
                ctx.beginPath();
                ctx.moveTo(x - 15, y);
                ctx.lineTo(x + 15, y);
                ctx.moveTo(x, y - 15);
                ctx.lineTo(x, y + 15);
                ctx.strokeStyle = '#3fb950';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        // Input listeners for manual adjustment
        const inputRa = document.getElementById('input-ra');
        const inputDec = document.getElementById('input-dec');
        let debounceTimer;

        function updateMarkerFromInputs() {
            const ra = inputRa.value;
            const dec = inputDec.value;
            const path = "{{ meta.path }}";

            if (!ra || !dec) {
                currentMarker = null; // Clear marker if inputs are empty
                draw();
                return;
            }

            // Ensure image is loaded before calculating scale
            if (!img.complete || img.naturalWidth === 0) {
                // Retry in a bit if image not ready
                setTimeout(updateMarkerFromInputs, 100);
                return;
            }

            // Fetch pixel coordinates
            const formData = new FormData();
            formData.append('path', path);
            formData.append('ra_deg', ra);
            formData.append('dec_deg', dec);

            fetch('/dashboard/analysis/project', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("Failed to parse response:", text);
                        throw e;
                    }
                })
                .then(data => {
                    if (data.x !== undefined && data.y !== undefined) {
                        // Scale pixel coordinates from natural image size to displayed image size
                        const rect = img.getBoundingClientRect();
                        const scaleX = rect.width / img.naturalWidth;
                        const scaleY = rect.height / img.naturalHeight;

                        currentMarker = { x: data.x * scaleX, y: data.y * scaleY };
                        draw();
                    } else {
                        currentMarker = null;
                        draw();
                    }
                })
                .catch(error => {
                    console.error("Error projecting coordinates:", error);
                    currentMarker = null;
                    draw();
                });
        }

        if (inputRa && inputDec) {
            const handler = function () {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateMarkerFromInputs, 500);
            };
            inputRa.addEventListener('input', handler);
            inputDec.addEventListener('input', handler);
        }

        // Initialize marker if association exists
        // We hook into the image load event to ensure dimensions are ready
        {% if association %}
        if (img.complete) {
            updateMarkerFromInputs();
        } else {
            img.addEventListener('load', function () {
                // Wait a tick for layout to settle
                setTimeout(updateMarkerFromInputs, 50);
            });
        }
        {% endif %}

        // Handle clicks on canvas
        canvas.addEventListener('click', function (e) {
            const rect = canvas.getBoundingClientRect();
            // Scale coordinates if canvas display size differs from actual size
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            points.push({ x, y });
            if (points.length >= 3) btnIdentify.disabled = false;
            draw();
        });

        canvas.addEventListener('mousemove', function (e) {
            if (points.length > 0) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                currentX = (e.clientX - rect.left) * scaleX;
                currentY = (e.clientY - rect.top) * scaleY;
                draw();
            }
        });

        canvas.addEventListener('mouseout', function () {
            isDrawing = false;
            draw();
        });

        btnIdentify.onclick = async function () {
            if (points.length < 3) return;

            // Convert points to image coordinates
            const rect = img.getBoundingClientRect();
            const scaleX = img.naturalWidth / rect.width;
            const scaleY = img.naturalHeight / rect.height;

            const imgPoints = points.map(p => ({
                x: p.x * scaleX,
                y: p.y * scaleY
            }));

            // Show loading
            loadingPanel.classList.remove('hidden');
            resultPanel.classList.add('hidden');
            errorPanel.classList.add('hidden');

            try {
                const resp = await fetch('/dashboard/analysis/resolve_click', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: "{{ meta.path }}",
                        polygon: imgPoints
                    })
                });

                const data = await resp.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Update Result Panel
                document.getElementById('res-ra').textContent = data.ra_deg.toFixed(5);
                document.getElementById('res-dec').textContent = data.dec_deg.toFixed(5);
                document.getElementById('res-snr').textContent = data.snr.toFixed(1);

                document.getElementById('input-ra').value = data.ra_deg.toFixed(5);
                document.getElementById('input-dec').value = data.dec_deg.toFixed(5);

                // Update marker based on new RA/Dec
                updateMarkerFromInputs();

                resultPanel.classList.remove('hidden');

            } catch (err) {
                document.getElementById('error-msg').textContent = err.message;
                errorPanel.classList.remove('hidden');
            } finally {
                loadingPanel.classList.add('hidden');
            }
        };
    })();
</script>