services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
      # - mock-nina
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
      SERVICE_NAME: api
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RUN_MIGRATIONS: 1
      # Direct NINA connection (bridge removed)
      NINA_URL: ${NINA_URL:-http://host.docker.internal:1888/api}
      # MOCK_NINA_URL: http://mock-nina:1888/api
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    ports:
      - "18080:8000"
    volumes:
      - ./app:/app/app
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - ./data:/data
      # Mount the shared NINA images folder
      - nina_images:/data/fits
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
  neocp-fetcher:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
      SERVICE_NAME: neocp-fetcher
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RUN_MIGRATIONS: 0
    command: ["python", "-m", "app.services.neocp_fetcher"]
    restart: unless-stopped
    ports:
      - "19500:9500"
    volumes:
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
  observability-engine:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
      SERVICE_NAME: observability-engine
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RUN_MIGRATIONS: 0
    command: ["python", "-m", "app.services.observability_engine"]
    restart: unless-stopped
    volumes:
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
# image-monitor: REMOVED - functionality moved to inline synchronous processing in api service
  # The image-monitor service has been removed as part of simplification.
  # File monitoring is now done synchronously during capture operations.
  # cron:
  #   image: postgres:15-alpine
  #   container_name: astro-neo-cron
  #   restart: unless-stopped
  #   depends_on:
  #     - db
  #   env_file:
  #     - .env
  #   environment:
  #     - PGPASSWORD=${POSTGRES_PASSWORD:-astro}
  #   volumes:
  #     - ./ops:/ops
  #     - ./data:/data
  #     - /etc/localtime:/etc/localtime:ro
  #     - /etc/timezone:/etc/timezone:ro
  #   # Run a simple loop to execute backup every night at 09:00 UTC (adjust as needed)
  #   # Or just sleep and let us exec into it.
  #   # For a real cron, we'd need to install cron.
  #   # Let's use a simple shell loop for MVP to avoid custom image build.
  #   # Run backup immediately on start (for verification) then sleep 24h?
  #   # Better: use a while loop checking time or just sleep.
  #   # For this task, I'll implement a simple loop that runs backup every 24h.
  #   command: >
  #     sh -c "apk add --no-cache bash &&
  #            while true; do
  #              echo 'Running daily backup...';
  #              /ops/backup.sh;
  #              echo 'Sleeping for 24 hours...';
  #              sleep 86400;
  #            done"
# astrometry-worker: REMOVED - astrometry.net installed directly in api container
  # The astrometry-worker service has been removed as part of simplification.
  # Plate solving is now done locally via subprocess in the api service.
# nina-bridge: REMOVED - API now calls NINA directly
  # The nina-bridge service has been removed as part of simplification.
  # The API service now communicates directly with NINA using host.docker.internal.
  # synthetic-targets: #Turn off neocp-fetcher
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   pull_policy: build
  #   depends_on:
  #     - db
  #   env_file:
  #     - .env
  #   environment:
  #     DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
  #     SERVICE_NAME: synthetic-targets
  #     LOG_LEVEL: ${LOG_LEVEL:-INFO}
  #     RUN_MIGRATIONS: 0
  #   command: ["python", "-m", "app.services.synthetic_targets"]
  #   restart: unless-stopped


#   mock-nina:
#     build:
#       context: .
#       dockerfile: mock_nina/Dockerfile
#     pull_policy: build
#     environment:
#       MOCK_NINA_DATA_DIR: /data
#       MOCK_NINA_EXPOSURE_SECONDS: 5
#     volumes:
#       - mock_nina_data:/data
#     ports:
#       - "1888:1888"

  db:
    image: postgres:15
    pull_policy: always
    restart: unless-stopped
    environment:
      POSTGRES_DB: astro
      POSTGRES_USER: astro
      POSTGRES_PASSWORD: astro
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

volumes:
  postgres_data:
  mock_nina_data:
  nina_images:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${NINA_IMAGES_HOST_PATH:-./data/fits}
