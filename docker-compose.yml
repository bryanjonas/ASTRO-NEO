version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
      # - mock-nina
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
      # MOCK_NINA_URL: http://mock-nina:1888/api
    ports:
      - "18080:8000"
    volumes:
      - ./app:/app/app
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - ./data:/data
  neocp-fetcher:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
    command: ["python", "-m", "app.services.neocp_fetcher"]
    restart: unless-stopped
    ports:
      - "19500:9500"
    volumes:
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
  observability-engine:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
    command: ["python", "-m", "app.services.observability_engine"]
    restart: unless-stopped
    volumes:
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
  # cron:
  #   image: postgres:15-alpine
  #   container_name: astro-neo-cron
  #   restart: unless-stopped
  #   depends_on:
  #     - db
  #   env_file:
  #     - .env
  #   environment:
  #     - PGPASSWORD=${POSTGRES_PASSWORD:-astro}
  #   volumes:
  #     - ./ops:/ops
  #     - ./data:/data
  #   # Run a simple loop to execute backup every night at 09:00 UTC (adjust as needed)
  #   # Or just sleep and let us exec into it.
  #   # For a real cron, we'd need to install cron.
  #   # Let's use a simple shell loop for MVP to avoid custom image build.
  #   # Run backup immediately on start (for verification) then sleep 24h?
  #   # Better: use a while loop checking time or just sleep.
  #   # For this task, I'll implement a simple loop that runs backup every 24h.
  #   command: >
  #     sh -c "apk add --no-cache bash &&
  #            while true; do
  #              echo 'Running daily backup...';
  #              /ops/backup.sh;
  #              echo 'Sleeping for 24 hours...';
  #              sleep 86400;
  #            done"
  # astrometry-worker:
  #   build:
  #     context: .
  #     dockerfile: docker/astrometry.Dockerfile
  #   pull_policy: build
  #   environment:
  #     ASTROMETRY_WORKER_URL: ""  # prevent recursive remote calls
  #     ASTROMETRY_CONFIG_FILE: /etc/astrometry.cfg
  #   volumes:
      - ./data:/data
    ports:
      - "18100:8100"
  nina-bridge:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
      # - mock-nina
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["uvicorn", "nina_bridge.main:app", "--host", "0.0.0.0", "--port", "8001"]
    restart: unless-stopped
    ports:
      - "1889:8001"
    volumes:
      - ./nina_bridge:/app/nina_bridge
      - ./app:/app/app
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - ./data:/data
#   mock-nina:
#     build:
#       context: .
#       dockerfile: mock_nina/Dockerfile
#     pull_policy: build
#     environment:
#       MOCK_NINA_DATA_DIR: /data
#       MOCK_NINA_EXPOSURE_SECONDS: 5
#     volumes:
#       - mock_nina_data:/data
#     ports:
#       - "1888:1888"

  db:
    image: postgres:15
    pull_policy: always
    environment:
      POSTGRES_DB: astro
      POSTGRES_USER: astro
      POSTGRES_PASSWORD: astro
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
  mock_nina_data:
