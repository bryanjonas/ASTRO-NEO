services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
      SERVICE_NAME: api
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RUN_MIGRATIONS: 1
      NINA_URL: ${NINA_URL:-http://host.docker.internal:1888/api}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    ports:
      - "18080:8000"
    volumes:
      - ./app:/app/app
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - ./data:/data
      - nina_images:/data/fits
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  neocp-fetcher:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
      SERVICE_NAME: neocp-fetcher
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RUN_MIGRATIONS: 0
    command: ["python", "-m", "app.services.neocp_fetcher"]
    restart: unless-stopped
    ports:
      - "19500:9500"
    volumes:
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  observability-engine:
    build:
      context: .
      dockerfile: Dockerfile
    pull_policy: build
    depends_on:
      - db
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg://astro:astro@db:5432/astro
      SERVICE_NAME: observability-engine
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RUN_MIGRATIONS: 0
    command: ["python", "-m", "app.services.observability_engine"]
    restart: unless-stopped
    volumes:
      - ./config:/app/config:ro
      - ./data/neocp_snapshots:/data/neocp_snapshots:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  db:
    image: postgres:15
    pull_policy: always
    restart: unless-stopped
    environment:
      POSTGRES_DB: astro
      POSTGRES_USER: astro
      POSTGRES_PASSWORD: astro
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

volumes:
  postgres_data:
  nina_images:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${NINA_IMAGES_HOST_PATH:-./data/fits}
